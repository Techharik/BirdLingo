<button id="extract">Extract Keys</button>

<div id="list"></div>

<h3>Select Languages</h3>

<label><input type="checkbox" value="en" checked /> English</label>
<label><input type="checkbox" value="es" /> Spanish</label>
<label><input type="checkbox" value="fr" /> French</label>

<button id="download">Download JSON</button>

<script>
    let extracted = [];

    document.getElementById("extract").onclick = () => {
        parent.postMessage(
            { pluginMessage: { type: "EXTRACT_KEYS" } },
            "*"
        );
    };

    window.onmessage = (event) => {

        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "KEYS_RESULT") {

            extracted = msg.data;
            renderList();
        }
    };

    function renderList() {
        const container = document.getElementById("list");
        container.innerHTML = "";

        extracted.forEach((item, index) => {

            const row = document.createElement("div");

            row.innerHTML = `
      <input value="${item.key}" data-index="${index}" class="key"/>
      <input value="${item.text}" disabled/>
      <button data-index="${index}" class="delete">X</button>
    `;

            container.appendChild(row);
        });

        document.querySelectorAll(".delete").forEach(btn => {
            btn.onclick = (e) => {
                const i = e.target.dataset.index;
                extracted.splice(i, 1);
                renderList();
            };
        });

        document.querySelectorAll(".key").forEach(input => {
            input.oninput = (e) => {
                const i = e.target.dataset.index;
                extracted[i].key = e.target.value;
            };
        });
    }

    document.getElementById("download").onclick = () => {

        const languages = [...document.querySelectorAll("input[type=checkbox]:checked")]
            .map(c => c.value);

        generateJSONFiles(extracted, languages);
    };

    function generateJSONFiles(items, languages) {

        languages.forEach(lang => {

            const json = {};

            items.forEach(item => {
                json[item.key] = item.text; // later you replace with translated text
            });

            downloadFile(`${lang}.json`, JSON.stringify(json, null, 2));
        });
    }

    function downloadFile(filename, content) {
        const blob = new Blob([content], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();

        URL.revokeObjectURL(url);
    }
</script>